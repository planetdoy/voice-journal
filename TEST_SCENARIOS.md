# 알림/리마인더 시스템 테스트 시나리오

## 🧪 테스트 환경 설정

### 1. 개발 서버 실행
```bash
npm run dev
```

### 2. 데이터베이스 상태 확인
```bash
npx prisma studio
```

---

## 📋 테스트 시나리오

### 시나리오 1: 알림 설정 UI 테스트
**목표**: 알림 설정 페이지가 정상 작동하는지 확인

#### 1-1. 설정 페이지 접근
1. 브라우저에서 `http://localhost:3000` 접속
2. 로그인 (Google OAuth)
3. 계정 설정 아이콘 클릭 
4. "알림" 탭 클릭

**예상 결과**:
- ✅ 알림 설정 UI가 표시됨
- ✅ 기본값이 올바르게 설정됨 (계획 21:00, 회고 07:00)
- ✅ 모든 토글 스위치가 작동함

#### 1-2. 알림 시간 변경 테스트
1. 계획 알림 시간을 현재 시간 + 2분으로 설정
2. 회고 알림 시간을 현재 시간 + 3분으로 설정
3. "설정 저장" 클릭

**예상 결과**:
- ✅ "알림 설정이 저장되었습니다" 토스트 메시지 표시
- ✅ 페이지 새로고침 후에도 설정값 유지

#### 1-3. 이메일 알림 토글 테스트
1. 이메일 알림 OFF → ON 변경
2. 설정 저장
3. 브라우저 개발자 도구 > Network 탭 확인

**예상 결과**:
- ✅ `/api/notifications/settings` PUT 요청 성공 (200)
- ✅ 응답 데이터에 `emailEnabled: true` 포함

---

### 시나리오 2: 브라우저 Push 알림 테스트
**목표**: 브라우저 푸시 알림 권한 및 구독이 정상 작동하는지 확인

#### 2-1. Push 알림 권한 요청
1. 알림 설정에서 "브라우저 알림" 토글을 ON으로 변경
2. 브라우저 권한 요청 팝업 → "허용" 클릭

**예상 결과**:
- ✅ 권한 요청 팝업 표시
- ✅ "브라우저 알림이 활성화되었습니다" 토스트 메시지
- ✅ 토글이 ON 상태로 유지

#### 2-2. Service Worker 등록 확인
1. 브라우저 개발자 도구 > Application 탭
2. Service Workers 섹션 확인

**예상 결과**:
- ✅ `/sw.js` Service Worker가 등록되어 있음
- ✅ Status가 "activated and is running"

#### 2-3. Push 구독 확인
1. 개발자 도구 > Application > Storage > IndexedDB 확인
2. 또는 Console에서 확인:
```javascript
navigator.serviceWorker.ready.then(reg => 
  reg.pushManager.getSubscription().then(console.log)
)
```

**예상 결과**:
- ✅ Push subscription 객체가 존재
- ✅ endpoint, keys 정보 포함

---

### 시나리오 3: 이메일 알림 API 테스트
**목표**: 크론 작업 API가 정상 작동하는지 확인

#### 3-1. 수동 크론 작업 테스트 (개발 환경)
1. API 테스트 도구 (Postman/Thunder Client) 또는 curl 사용
```bash
curl -X POST http://localhost:3000/api/cron/reminders \
  -H "Content-Type: application/json"
```

**예상 결과**:
- ✅ 200 OK 응답
- ✅ `{ "success": true, "message": "Manual reminder notifications sent" }`
- ✅ 서버 콘솔에 로그 출력

#### 3-2. 인증 헤더 테스트 (보안 확인)
```bash
curl -X GET http://localhost:3000/api/cron/reminders \
  -H "Authorization: Bearer your-cron-secret-key"
```
(CRON_SECRET 값 사용)

**예상 결과**:
- ✅ 올바른 키: 200 OK 응답
- ✅ 잘못된 키: 401 Unauthorized

---

### 시나리오 4: 실제 이메일 발송 테스트
**목표**: 이메일이 실제로 발송되는지 확인

#### 4-1. 이메일 설정 확인
1. `.env.local` 파일에서 SMTP 설정 확인:
```env
SMTP_USER=doydoit@gmail.com
SMTP_PASS=mjuxpptpqnxwqmci
ADMIN_EMAIL=doydoit.b@gmail.com
```

#### 4-2. 테스트 시나리오 실행
1. 알림 시간을 현재 시간 + 1분으로 설정
2. 이메일 알림 활성화
3. 1분 후 수동 크론 실행:
```bash
curl -X POST http://localhost:3000/api/cron/reminders
```

**예상 결과**:
- ✅ 설정된 이메일 주소로 알림 메일 수신
- ✅ 이메일 제목: "🌟 Voice Journal - 내일을 위한 계획을 세워보세요"
- ✅ HTML 템플릿이 정상 렌더링

#### 4-3. 알림 로그 확인
1. Prisma Studio에서 `notification_logs` 테이블 확인
2. 또는 데이터베이스 직접 쿼리:
```sql
SELECT * FROM notification_logs ORDER BY created_at DESC LIMIT 5;
```

**예상 결과**:
- ✅ 발송 로그가 기록됨
- ✅ `status = 'sent'`, `sent_at` 값 존재

---

### 시나리오 5: 시간대 처리 테스트
**목표**: 사용자 시간대가 올바르게 처리되는지 확인

#### 5-1. 시간대 변경 테스트
1. 알림 설정에서 시간대 확인 (현재: Asia/Seoul)
2. 브라우저 개발자 도구 > Console에서 시뮬레이션:
```javascript
// 다른 시간대로 변경
Intl.DateTimeFormat().resolvedOptions().timeZone
```

#### 5-2. 시간대별 알림 시간 계산 확인
1. 서버 로그에서 시간 계산 결과 확인
2. 예상 시간과 실제 발송 시간 비교

**예상 결과**:
- ✅ 사용자 시간대 기준으로 알림 발송
- ✅ UTC 변환이 정확히 수행됨

---

### 시나리오 6: 에러 처리 테스트
**목표**: 예외 상황에서 시스템이 안정적으로 작동하는지 확인

#### 6-1. 잘못된 이메일 설정
1. `.env.local`에서 `SMTP_PASS`를 임시로 잘못된 값으로 변경
2. 수동 크론 실행
3. 로그 확인

**예상 결과**:
- ✅ 에러 로그 기록 (`status = 'failed'`)
- ✅ 시스템이 중단되지 않음
- ✅ 에러 메시지가 로그에 저장

#### 6-2. 데이터베이스 연결 오류 시뮬레이션
1. `DATABASE_URL`을 임시로 잘못된 값으로 변경
2. API 호출 테스트

**예상 결과**:
- ✅ 500 에러 응답
- ✅ 적절한 에러 메시지 반환

---

## 🚀 성능 테스트

### 시나리오 7: 대량 사용자 알림 테스트
**목표**: 많은 사용자에 대한 알림 처리 성능 확인

#### 7-1. 테스트 데이터 생성
1. Prisma Studio에서 테스트 사용자 5-10명 생성
2. 각 사용자별 알림 설정 활성화

#### 7-2. 동시 발송 테스트
1. 모든 사용자의 알림 시간을 동일하게 설정
2. 수동 크론 실행
3. 실행 시간 및 메모리 사용량 모니터링

**예상 결과**:
- ✅ 30초 이내 모든 이메일 발송 완료
- ✅ 메모리 누수 없음
- ✅ 모든 로그 정상 기록

---

## 📊 테스트 체크리스트

### 기본 기능 테스트
- [ ] 알림 설정 UI 로딩
- [ ] 설정값 저장/로딩
- [ ] 토글 스위치 작동
- [ ] 시간 입력 컴포넌트 작동

### Push 알림 테스트
- [ ] Service Worker 등록
- [ ] 권한 요청 팝업
- [ ] Push 구독 생성
- [ ] 구독 해제 기능

### 이메일 알림 테스트
- [ ] SMTP 연결 성공
- [ ] 이메일 템플릿 렌더링
- [ ] 실제 메일 발송
- [ ] 발송 로그 기록

### 시간/시간대 테스트
- [ ] 사용자 시간대 감지
- [ ] 시간 계산 정확성
- [ ] 알림 발송 시점 정확성

### 보안 테스트
- [ ] CRON_SECRET 인증
- [ ] 비인증 접근 차단
- [ ] SQL Injection 방어

### 에러 처리 테스트
- [ ] 잘못된 SMTP 설정
- [ ] 데이터베이스 연결 오류
- [ ] 네트워크 오류 처리

---

## 💡 테스트 실행 팁

1. **단계별 진행**: 각 시나리오를 순서대로 실행
2. **로그 모니터링**: 서버 콘솔과 브라우저 개발자 도구 동시 확인
3. **데이터 확인**: Prisma Studio로 데이터베이스 변경사항 실시간 모니터링
4. **이메일 확인**: 실제 이메일 수신함 및 스팸 폴더 확인
5. **성능 측정**: 크론 작업 실행 시간 및 리소스 사용량 체크

## 🐛 문제 발생 시 체크포인트

1. **환경 변수 확인**: `.env.local` 모든 값 설정 여부
2. **데이터베이스 연결**: Prisma Studio 접속 가능 여부  
3. **이메일 설정**: Gmail 앱 비밀번호 정확성
4. **포트 충돌**: 3000 포트 사용 가능 여부
5. **브라우저 권한**: 알림 권한 차단 여부

---

각 시나리오를 차례대로 실행해보시고, 문제가 발생하면 해당 시나리오 번호와 함께 알려주세요!